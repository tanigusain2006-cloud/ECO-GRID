<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EcoGrid: Sky Sorter</title>
<style>
  :root {
    --bg: #0a2e1a;
    --surface: #0f3d22;
    --surface2: #143d24;
    --accent: #4caf50;
    --bright: #76ff03;
    --text: #e8f5e9;
    --muted: #a5d6a7;
    --radius: 12px;
    --organic: #4caf50;
    --recyclable: #2196f3;
    --hazardous: #f44336;
    --ewaste: #9e9e9e;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ */
  nav {
    background: var(--surface);
    border-bottom: 1px solid #1e5c2e;
    padding: 0 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
    position: sticky; top: 0; z-index: 200;
  }
  .nav-logo {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--bright);
    letter-spacing: 1px;
    text-decoration: none;
  }
  .nav-links { display: flex; gap: 0.25rem; list-style: none; }
  .nav-links a {
    color: var(--muted);
    text-decoration: none;
    padding: 0.5rem 0.9rem;
    border-radius: var(--radius);
    font-size: 0.9rem;
    transition: background 200ms ease, color 200ms ease;
  }
  .nav-links a:hover { background: #1e5c2e; color: var(--text); }
  .nav-links a.active { background: var(--accent); color: #fff; font-weight: 600; }
  .nav-links a:focus-visible { outline: 2px solid var(--bright); outline-offset: 2px; }
  @media(max-width:520px){
    .nav-logo { font-size:1rem; }
    .nav-links a { padding:0.4rem 0.55rem; font-size:0.78rem; }
  }

  /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
  .wrapper { max-width: 900px; margin: 0 auto; padding: 1.5rem 1rem; }
  .game-header { text-align: center; margin-bottom: 1.5rem; }
  .game-header h1 { font-size: clamp(1.6rem, 4vw, 2.4rem); color: var(--bright); letter-spacing: 2px; }
  .game-header p { color: var(--muted); margin-top: 0.3rem; font-size: 0.95rem; }

  /* ‚îÄ‚îÄ‚îÄ MODE SELECT ‚îÄ‚îÄ‚îÄ */
  #modeSelect { display: block; }
  .mode-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 1rem; margin: 1.5rem 0; }
  .mode-card {
    background: var(--surface);
    border: 1px solid #1e5c2e;
    border-radius: var(--radius);
    padding: 1.4rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: transform 200ms ease, border-color 200ms ease, box-shadow 200ms ease;
  }
  .mode-card:hover, .mode-card:focus { transform: translateY(-3px); border-color: var(--accent); box-shadow: 0 6px 20px rgba(76,175,80,0.2); outline: none; }
  .mode-card .icon { font-size: 2rem; margin-bottom: 0.6rem; }
  .mode-card h3 { color: var(--bright); font-size: 1rem; margin-bottom: 0.3rem; }
  .mode-card p { color: var(--muted); font-size: 0.8rem; }
  .menu-btns { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 1rem; }
  .btn {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 0.75rem 1.6rem;
    border-radius: var(--radius);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 200ms ease, transform 150ms ease;
  }
  .btn:hover { background: #43a047; transform: translateY(-1px); }
  .btn:focus-visible { outline: 2px solid var(--bright); outline-offset: 3px; }
  .btn-ghost {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
  }
  .btn-ghost:hover { background: rgba(76,175,80,0.1); }
  .btn-danger { background: #c62828; }
  .btn-danger:hover { background: #b71c1c; }

  /* ‚îÄ‚îÄ‚îÄ GAME AREA ‚îÄ‚îÄ‚îÄ */
  #gameArea { display: none; }

  /* Top row: score / combo / level / timer */
  .hud-top {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--surface);
    border-radius: var(--radius) var(--radius) 0 0;
    padding: 0.6rem 1.25rem;
    border-bottom: 1px solid #1a4d25;
    flex-wrap: wrap;
  }
  /* Bottom row: meter dashboard */
  .hud-meters {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0;
    background: #0c3318;
    border-radius: 0 0 var(--radius) var(--radius);
    overflow: hidden;
    margin-bottom: 0.75rem;
    border: 1px solid #1e5c2e;
    border-top: none;
  }
  .meter-cell {
    padding: 0.55rem 0.75rem;
    border-right: 1px solid #1a4d25;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  .meter-cell:last-child { border-right: none; }
  .meter-cell-top {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }
  .meter-cell-label {
    font-size: 0.68rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    white-space: nowrap;
  }
  .meter-cell-pct {
    font-size: 1rem;
    font-weight: 700;
    line-height: 1;
    transition: color 200ms ease;
  }
  .meter-track { background: #1e5c2e; border-radius: 4px; height: 8px; overflow: hidden; }
  .meter-fill { height: 100%; border-radius: 4px; transition: width 180ms ease; }

  /* Stat items in top row */
  .hud-item { display: flex; flex-direction: column; align-items: center; min-width: 52px; }
  .hud-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.4px; }
  .hud-value { font-size: 1.25rem; font-weight: 700; color: var(--bright); line-height: 1.2; }

  .meter-fill.recycle    { background: var(--accent); }
  .meter-fill.contam     { background: #f44336; }
  .meter-fill.cityhealth { background: linear-gradient(90deg, #76ff03, #4caf50); }
  .meter-fill.landfill   { background: linear-gradient(90deg, #ff6f00, #b71c1c); }
  .meter-fill.landfill.danger { animation: landfill-pulse 0.5s ease infinite alternate; }
  @keyframes landfill-pulse { from { opacity:1; } to { opacity:0.55; } }

  /* Level-up flash */
  .levelup-flash {
    display: none;
    position: absolute;
    top: 0; left: 0; right: 0;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--bright);
    background: rgba(118,255,3,0.15);
    padding: 0.3rem;
    border-radius: var(--radius);
    pointer-events: none;
    z-index: 10;
    letter-spacing: 1px;
  }
  .levelup-flash.show { display: block; animation: lvlFlash 0.7s ease forwards; }
  @keyframes lvlFlash {
    0%   { opacity:0; transform:scale(0.9); }
    20%  { opacity:1; transform:scale(1.05); }
    70%  { opacity:1; }
    100% { opacity:0; transform:scale(1); }
  }

  #gameCanvas {
    display: block;
    width: 100%;
    border-radius: var(--radius);
    border: 1px solid #1e5c2e;
    background: #071a0e;
    touch-action: none;
  }
  /* ‚îÄ‚îÄ‚îÄ D-PAD CONTROLS ‚îÄ‚îÄ‚îÄ */
  .controls-panel {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }
  /* Current bin indicator */
  .bin-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    min-width: 110px;
  }
  .bin-indicator-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .bin-indicator-badge {
    padding: 0.45rem 1.1rem;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 700;
    color: #fff;
    border: 2px solid var(--bright);
    box-shadow: 0 0 10px rgba(118,255,3,0.3);
    transition: background 180ms ease, box-shadow 180ms ease;
    white-space: nowrap;
  }
  .bin-indicator-hint { font-size: 0.68rem; color: var(--muted); }
  /* D-pad grid */
  .dpad {
    display: grid;
    grid-template-columns: 52px 52px 52px;
    grid-template-rows: 48px 48px 48px;
    gap: 4px;
  }
  .dpad-btn {
    background: var(--surface);
    border: 1px solid #2a6e38;
    border-radius: 10px;
    color: var(--text);
    font-size: 1.2rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    user-select: none;
    -webkit-user-select: none;
    transition: background 100ms, transform 80ms;
    touch-action: none;
  }
  .dpad-btn:active, .dpad-btn.pressed { background: #2a6e38; transform: scale(0.93); }
  .dpad-btn:focus-visible { outline: 2px solid var(--bright); }
  .dpad-btn.dpad-center {
    background: rgba(76,175,80,0.12);
    border-color: var(--accent);
    font-size: 1rem;
    color: var(--accent);
  }
  .dpad-btn.dpad-empty { background: transparent; border-color: transparent; pointer-events: none; }
  .controls-hint { text-align: center; color: var(--muted); font-size: 0.78rem; margin-top: 0.5rem; }

  /* ‚îÄ‚îÄ‚îÄ PAUSE OVERLAY ‚îÄ‚îÄ‚îÄ */
  .overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(7, 26, 14, 0.88);
    z-index: 300;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 1.5rem;
  }
  .overlay.show { display: flex; }
  .overlay-card {
    background: var(--surface);
    border: 1px solid #1e5c2e;
    border-radius: var(--radius);
    padding: 2.5rem 2rem;
    max-width: 460px;
    width: 90%;
    text-align: center;
  }
  .overlay-card h2 { font-size: 1.8rem; color: var(--bright); margin-bottom: 0.5rem; }
  .overlay-card p { color: var(--muted); line-height: 1.6; margin-bottom: 0.5rem; }
  .overlay-card .impact-icon { font-size: 4rem; margin-bottom: 1rem; }
  .overlay-btns { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem; }
  .final-score { font-size: 2.8rem; font-weight: 700; color: var(--bright); margin: 0.5rem 0 0.25rem; }
  .final-rank  { color: var(--accent); font-size: 1rem; margin-bottom: 1rem; font-weight: 600; }

  /* End stats grid */
  .end-stats-grid { display:flex; flex-direction:column; gap:0.55rem; margin:0.75rem 0 1rem; }
  .end-stat-row { display:flex; flex-direction:column; gap:0.25rem; }
  .end-stat-info { display:flex; align-items:center; gap:0.4rem; }
  .end-stat-icon { font-size:0.9rem; }
  .end-stat-label { font-size:0.78rem; color:var(--muted); flex:1; text-align:left; }
  .end-stat-pct { font-size:0.9rem; font-weight:700; min-width:38px; text-align:right; }
  .end-stat-bar-track { height:8px; background:#1e5c2e; border-radius:4px; overflow:hidden; }
  .end-stat-bar { height:100%; border-radius:4px; width:0%; transition:width 0.8s cubic-bezier(0.16,1,0.3,1); }
  .end-stat-bar.recycle    { background: var(--accent); }
  .end-stat-bar.contam     { background: #f44336; }
  .end-stat-bar.cityhealth { background: linear-gradient(90deg, #76ff03, #4caf50); }
  .end-stat-bar.landfill   { background: linear-gradient(90deg, #ff6f00, #b71c1c); }
  .final-rank { color: var(--accent); font-size: 1.1rem; margin-bottom: 1rem; }

  /* ‚îÄ‚îÄ‚îÄ CITY IMPACT SCREEN ‚îÄ‚îÄ‚îÄ */
  #cityImpactScreen {
    display: none;
    position: fixed; inset: 0;
    background: rgba(7, 26, 14, 0.97);
    z-index: 400;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
    padding: 2rem;
    cursor: pointer;
  }
  #cityImpactScreen.show { display: flex; }
  #cityImpactScreen .city-icon { font-size: 5rem; margin-bottom: 1.5rem; }
  #cityImpactScreen h2 { font-size: 1.5rem; color: var(--bright); margin-bottom: 1rem; }
  #cityImpactScreen .city-msg { font-size: 1.05rem; color: var(--text); max-width: 500px; line-height: 1.7; margin-bottom: 2rem; }
  #cityImpactScreen .dismiss-hint { color: var(--muted); font-size: 0.85rem; }

  /* ‚îÄ‚îÄ‚îÄ ECO FACT OVERLAY ‚îÄ‚îÄ‚îÄ */
  #ecoFactScreen {
    display: none;
    position: fixed; inset: 0;
    background: rgba(7,26,14,0.94);
    z-index: 350;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
    padding: 2rem;
    cursor: pointer;
  }
  #ecoFactScreen.show { display: flex; }
  #ecoFactScreen .fact-icon { font-size: 3rem; margin-bottom: 1rem; }
  #ecoFactScreen h3 { color: var(--bright); margin-bottom: 0.75rem; }
  #ecoFactScreen p { color: var(--text); max-width: 440px; line-height: 1.6; margin-bottom: 1.5rem; }
  #ecoFactScreen .dismiss-hint { color: var(--muted); font-size: 0.8rem; }

  /* ‚îÄ‚îÄ‚îÄ HOW TO PLAY MODAL ‚îÄ‚îÄ‚îÄ */
  #howToPlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(7,26,14,0.92);
    z-index: 500;
    overflow-y: auto;
    padding: 2rem 1rem;
  }
  #howToPlay.show { display: block; }
  .htp-inner {
    background: var(--surface);
    border: 1px solid #1e5c2e;
    border-radius: var(--radius);
    max-width: 700px;
    margin: 0 auto;
    padding: 2rem;
    position: relative;
  }
  .htp-inner h2 { color: var(--bright); font-size: 1.5rem; margin-bottom: 1.5rem; }
  .htp-close {
    position: absolute; top: 1rem; right: 1rem;
    background: none; border: none; color: var(--muted);
    font-size: 1.4rem; cursor: pointer; line-height: 1;
    padding: 0.25rem 0.5rem; border-radius: 6px;
    transition: color 200ms;
  }
  .htp-close:hover { color: var(--text); }
  .htp-section { margin-bottom: 1.75rem; }
  .htp-section h3 { color: var(--accent); font-size: 1rem; margin-bottom: 0.75rem; padding-bottom: 0.3rem; border-bottom: 1px solid #1e5c2e; }
  .htp-section p { color: var(--muted); line-height: 1.6; margin-bottom: 0.6rem; font-size: 0.9rem; }
  .bin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap: 0.75rem; }
  .bin-card { background: var(--bg); border-radius: 8px; padding: 0.75rem; border-left: 3px solid; }
  .bin-card.org { border-color: var(--organic); }
  .bin-card.rec { border-color: var(--recyclable); }
  .bin-card.haz { border-color: var(--hazardous); }
  .bin-card.ewaste { border-color: var(--ewaste); }
  .bin-card h4 { font-size: 0.85rem; margin-bottom: 0.3rem; }
  .bin-card p { font-size: 0.78rem; color: var(--muted); line-height: 1.5; }
  .consequence-box {
    background: rgba(76,175,80,0.08);
    border: 1px solid rgba(76,175,80,0.25);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 0.5rem;
  }
  .consequence-box h4 { color: var(--accent); margin-bottom: 0.5rem; font-size: 0.9rem; }

  /* ‚îÄ‚îÄ‚îÄ HIGH SCORES ‚îÄ‚îÄ‚îÄ */
  #highScoresPanel { display: none; }
  .scores-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  .scores-table th { color: var(--muted); font-size: 0.8rem; text-align: left; padding: 0.4rem 0.75rem; border-bottom: 1px solid #1e5c2e; }
  .scores-table td { color: var(--text); font-size: 0.9rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid #0f2a17; }
  .no-scores { color: var(--muted); text-align: center; padding: 2rem; }

  /* Responsive */
  @media(max-width:600px){
    .mode-grid { grid-template-columns: 1fr 1fr; }
    .hud { gap: 0.5rem; padding: 0.5rem 0.75rem; }
    .hud-value { font-size: 1rem; }
    .htp-inner { padding: 1.5rem; }
  }

  /* quiz */
  .quiz-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(7,26,14,0.95);
    z-index: 450;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }
  .quiz-overlay.show { display: flex; }
  .quiz-card {
    background: var(--surface);
    border: 1px solid #1e5c2e;
    border-radius: var(--radius);
    padding: 2rem;
    max-width: 480px;
    width: 100%;
    text-align: center;
  }
  .quiz-card h3 { color: var(--bright); margin-bottom: 1rem; }
  .quiz-card p { color: var(--text); margin-bottom: 1.5rem; line-height: 1.6; }
  .quiz-opts { display: flex; flex-direction: column; gap: 0.6rem; }
  .quiz-opt {
    background: var(--bg);
    border: 1px solid #1e5c2e;
    border-radius: 8px;
    color: var(--text);
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 200ms ease;
    text-align: left;
    font-size: 0.9rem;
  }
  .quiz-opt:hover { border-color: var(--accent); background: #0f2a17; }
  .quiz-opt.correct { border-color: var(--accent); background: rgba(76,175,80,0.2); color: var(--bright); }
  .quiz-opt.wrong { border-color: var(--hazardous); background: rgba(244,67,54,0.15); }
  .quiz-feedback { margin-top: 1rem; font-size: 0.9rem; color: var(--muted); }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ -->
<nav>
  <a href="index.html" class="nav-logo">ECOGRID</a>
  <ul class="nav-links">
    <li><a href="index.html" class="active" aria-current="page">Play</a></li>
    <li><a href="learn.html">Learn</a></li>
    <li><a href="educator.html">Educator</a></li>
  </ul>
</nav>

<div class="wrapper">

  <!-- ‚îÄ‚îÄ‚îÄ MODE SELECT ‚îÄ‚îÄ‚îÄ -->
  <section id="modeSelect">
    <div class="game-header">
      <h1>SKY SORTER</h1>
      <p>Sort waste. Save the planet.</p>
    </div>
    <div class="mode-grid" role="list">
      <div class="mode-card" role="listitem" tabindex="0" data-mode="classic" aria-label="Classic mode: endless arcade">
        <div class="icon">‚ôæÔ∏è</div>
        <h3>Classic</h3>
        <p>Endless arcade</p>
      </div>
      <div class="mode-card" role="listitem" tabindex="0" data-mode="timed" aria-label="Timed mode: 3-minute rush">
        <div class="icon">‚è±Ô∏è</div>
        <h3>Timed</h3>
        <p>3-minute rush</p>
      </div>
      <div class="mode-card" role="listitem" tabindex="0" data-mode="campaign" aria-label="Campaign mode: level progression with quizzes">
        <div class="icon">üó∫Ô∏è</div>
        <h3>Campaign</h3>
        <p>Level progression</p>
      </div>
      <div class="mode-card" role="listitem" tabindex="0" data-mode="challenge" aria-label="Challenge mode: plastic only fast pace">
        <div class="icon">‚ö°</div>
        <h3>Challenge</h3>
        <p>Plastic only</p>
      </div>
    </div>
    <div class="menu-btns">
      <button class="btn" id="playBtn">‚ñ∂ PLAY NOW</button>
      <button class="btn btn-ghost" id="howToPlayBtn">üìñ HOW TO PLAY</button>
      <button class="btn btn-ghost" id="highScoresBtn">üèÜ HIGH SCORES</button>
    </div>
    <p class="controls-hint" style="margin-top:1.25rem;">‚Üê ‚Üí Move bucket &nbsp;|&nbsp; 1‚Äì4 Switch bin &nbsp;|&nbsp; P Pause</p>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ HIGH SCORES ‚îÄ‚îÄ‚îÄ -->
  <section id="highScoresPanel">
    <div class="game-header"><h1>HIGH SCORES</h1></div>
    <table class="scores-table" role="table" aria-label="High scores">
      <thead><tr><th>#</th><th>Score</th><th>Rank</th><th>Mode</th></tr></thead>
      <tbody id="scoresTbody"></tbody>
    </table>
    <p class="no-scores" id="noScoresMsg" style="display:none;">No scores yet ‚Äî play a round first!</p>
    <div class="menu-btns" style="margin-top:1.5rem;">
      <button class="btn" id="backFromScores">‚Üê Back</button>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ GAME AREA ‚îÄ‚îÄ‚îÄ -->
  <section id="gameArea">
    <div role="status" aria-live="polite" style="position:relative;">
      <!-- Level-up flash overlay -->
      <div class="levelup-flash" id="levelupFlash">‚¨Ü LEVEL UP!</div>

      <!-- Top row: score / combo / level / timer -->
      <div class="hud-top">
        <div class="hud-item">
          <span class="hud-label">Score</span>
          <span class="hud-value" id="hudScore">0</span>
        </div>
        <div class="hud-item">
          <span class="hud-label">Combo</span>
          <span class="hud-value" id="hudCombo">√ó1</span>
        </div>
        <div class="hud-item">
          <span class="hud-label">Level</span>
          <span class="hud-value" id="hudLevel">1</span>
        </div>
        <div class="hud-item" id="timerHud" style="display:none;">
          <span class="hud-label">Time</span>
          <span class="hud-value" id="hudTimer">3:00</span>
        </div>
      </div>

      <!-- Bottom row: 4 meter cells with % -->
      <div class="hud-meters">
        <div class="meter-cell">
          <div class="meter-cell-top">
            <span class="meter-cell-label">‚ôªÔ∏è Recycle</span>
            <span class="meter-cell-pct" id="recyclePct" style="color:var(--accent)">0%</span>
          </div>
          <div class="meter-track">
            <div class="meter-fill recycle" id="recycleMeter" style="width:0%"
              role="progressbar" aria-label="Recycle meter" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
        <div class="meter-cell">
          <div class="meter-cell-top">
            <span class="meter-cell-label">‚ò£Ô∏è Contam.</span>
            <span class="meter-cell-pct" id="contamPct" style="color:#ef9a9a">0%</span>
          </div>
          <div class="meter-track">
            <div class="meter-fill contam" id="contamMeter" style="width:0%"
              role="progressbar" aria-label="Contamination" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
        <div class="meter-cell">
          <div class="meter-cell-top">
            <span class="meter-cell-label">üèôÔ∏è City</span>
            <span class="meter-cell-pct" id="cityPct" style="color:var(--bright)">50%</span>
          </div>
          <div class="meter-track">
            <div class="meter-fill cityhealth" id="cityHealthMeter" style="width:50%"
              role="progressbar" aria-label="City health" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
        <div class="meter-cell">
          <div class="meter-cell-top">
            <span class="meter-cell-label">üóëÔ∏è Landfill</span>
            <span class="meter-cell-pct" id="landfillPct" style="color:#ff8f00">0%</span>
          </div>
          <div class="meter-track">
            <div class="meter-fill landfill" id="landfillMeter" style="width:0%"
              role="progressbar" aria-label="Landfill" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
      </div>
    </div>

    <canvas id="gameCanvas" width="800" height="500" aria-label="EcoGrid game canvas" role="img"></canvas>

    <div class="controls-panel" role="group" aria-label="Game controls">
      <!-- D-pad -->
      <div class="dpad" aria-label="Directional controls">
        <!-- Row 1: up bin -->
        <div class="dpad-btn dpad-empty" aria-hidden="true"></div>
        <button class="dpad-btn" id="upBtn" aria-label="Previous bin (up)">‚ñ≤</button>
        <div class="dpad-btn dpad-empty" aria-hidden="true"></div>
        <!-- Row 2: left / pause / right -->
        <button class="dpad-btn" id="leftBtn" aria-label="Move bucket left">‚óÄ</button>
        <button class="dpad-btn dpad-center" id="pauseBtn" aria-label="Pause game">‚è∏</button>
        <button class="dpad-btn" id="rightBtn" aria-label="Move bucket right">‚ñ∂</button>
        <!-- Row 3: down bin -->
        <div class="dpad-btn dpad-empty" aria-hidden="true"></div>
        <button class="dpad-btn" id="downBtn" aria-label="Next bin (down)">‚ñº</button>
        <div class="dpad-btn dpad-empty" aria-hidden="true"></div>
      </div>
      <!-- Active bin indicator -->
      <div class="bin-indicator">
        <span class="bin-indicator-label">Current Bin</span>
        <span class="bin-indicator-badge" id="binBadge">1 üåø Organic</span>
        <span class="bin-indicator-hint">‚ñ≤‚ñº to switch</span>
      </div>
    </div>
    <p class="controls-hint" id="eventBanner" style="min-height:1.2em; color: var(--bright); text-align:center;"></p>
  </section>

</div><!-- /wrapper -->

<!-- ‚îÄ‚îÄ‚îÄ PAUSE OVERLAY ‚îÄ‚îÄ‚îÄ -->
<div class="overlay" id="pauseOverlay" role="dialog" aria-modal="true" aria-label="Game paused">
  <div class="overlay-card">
    <h2>PAUSED</h2>
    <p>Take a breath. The waste isn't going anywhere.</p>
    <div class="overlay-btns">
      <button class="btn" id="resumeBtn">‚ñ∂ Resume</button>
      <button class="btn btn-ghost" id="menuBtn">üè† Main Menu</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ CITY IMPACT SCREEN ‚îÄ‚îÄ‚îÄ -->
<div id="cityImpactScreen" role="dialog" aria-modal="true" aria-live="assertive" aria-label="City impact results">
  <div class="city-icon" id="cityIcon">üåÜ</div>
  <h2>City Impact</h2>
  <p class="city-msg" id="cityMsg">Your sorting affected the city.</p>
  <p class="dismiss-hint">Tap anywhere or press any key to continue...</p>
</div>

<!-- ‚îÄ‚îÄ‚îÄ ECO FACT OVERLAY ‚îÄ‚îÄ‚îÄ -->
<div id="ecoFactScreen" role="dialog" aria-modal="true" aria-label="Environmental fact">
  <div class="fact-icon">üåç</div>
  <h3>üí° Did You Know?</h3>
  <p id="ecoFactText">Loading fact...</p>
  <p class="dismiss-hint">Tap or press any key to continue...</p>
</div>

<!-- ‚îÄ‚îÄ‚îÄ GAME OVER OVERLAY ‚îÄ‚îÄ‚îÄ -->
<div class="overlay" id="gameOverOverlay" role="dialog" aria-modal="true" aria-label="Game over screen">
  <div class="overlay-card">
    <h2>GAME OVER</h2>
    <p id="gameOverCause" style="font-size:0.85rem;margin-bottom:0.5rem;"></p>
    <div class="final-score" id="finalScore">0</div>
    <div class="final-rank" id="finalRank">Eco Rookie</div>

    <!-- Full stats breakdown -->
    <div class="end-stats-grid">
      <div class="end-stat-row">
        <div class="end-stat-info">
          <span class="end-stat-icon">‚ôªÔ∏è</span>
          <span class="end-stat-label">Recycle</span>
          <span class="end-stat-pct" id="finalRecyclePct">0%</span>
        </div>
        <div class="end-stat-bar-track">
          <div class="end-stat-bar recycle" id="finalRecycleBar" style="width:0%"></div>
        </div>
      </div>
      <div class="end-stat-row">
        <div class="end-stat-info">
          <span class="end-stat-icon">‚ò£Ô∏è</span>
          <span class="end-stat-label">Contamination</span>
          <span class="end-stat-pct" id="finalcontamPct">0%</span>
        </div>
        <div class="end-stat-bar-track">
          <div class="end-stat-bar contam" id="finalContamBar" style="width:0%"></div>
        </div>
      </div>
      <div class="end-stat-row">
        <div class="end-stat-info">
          <span class="end-stat-icon">üèôÔ∏è</span>
          <span class="end-stat-label">City Health</span>
          <span class="end-stat-pct" id="finalCityHealth">50%</span>
        </div>
        <div class="end-stat-bar-track">
          <div class="end-stat-bar cityhealth" id="finalCityBar" style="width:50%"></div>
        </div>
      </div>
      <div class="end-stat-row">
        <div class="end-stat-info">
          <span class="end-stat-icon">üóëÔ∏è</span>
          <span class="end-stat-label">Landfill</span>
          <span class="end-stat-pct" id="finalLandfill">0%</span>
        </div>
        <div class="end-stat-bar-track">
          <div class="end-stat-bar landfill" id="finalLandfillBar" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div class="overlay-btns">
      <button class="btn" id="playAgainBtn">‚ñ∂ Play Again</button>
      <button class="btn btn-ghost" id="mainMenuBtn">üè† Main Menu</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ QUIZ OVERLAY ‚îÄ‚îÄ‚îÄ -->
<div class="quiz-overlay" id="quizOverlay" role="dialog" aria-modal="true" aria-label="Eco quiz bonus">
  <div class="quiz-card">
    <h3>üß† Eco Quiz Bonus</h3>
    <p id="quizQuestion">Loading...</p>
    <div class="quiz-opts" id="quizOpts" role="list"></div>
    <p class="quiz-feedback" id="quizFeedback" aria-live="polite"></p>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ HOW TO PLAY ‚îÄ‚îÄ‚îÄ -->
<div id="howToPlay" role="dialog" aria-modal="true" aria-label="How to play EcoGrid">
  <div class="htp-inner">
    <button class="htp-close" id="htpClose" aria-label="Close how to play">‚úï</button>
    <h2>üìñ HOW TO PLAY</h2>

    <div class="htp-section">
      <h3>üéØ Objective</h3>
      <p>Waste items fall from the sky. Catch each item in the correct color-coded bucket before contamination reaches 100%. Sort correctly to build combos and keep your virtual city clean.</p>
    </div>

    <div class="htp-section">
      <h3>ü™£ The Four Bins</h3>
      <div class="bin-grid">
        <div class="bin-card org">
          <h4>üåø Green ‚Äî Organic (1)</h4>
          <p>Banana peel, apple core, leaves, food scraps</p>
        </div>
        <div class="bin-card rec">
          <h4>‚ôªÔ∏è Blue ‚Äî Recyclable (2)</h4>
          <p>Plastic bottle, newspaper, cardboard, glass, metal can</p>
        </div>
        <div class="bin-card haz">
          <h4>‚ò£Ô∏è Red ‚Äî Hazardous (3)</h4>
          <p>Syringe, chemicals, paint can</p>
        </div>
        <div class="bin-card ewaste">
          <h4>üíæ Grey ‚Äî E-Waste (4)</h4>
          <p>Battery, old phone, light bulb, circuit board</p>
        </div>
      </div>
    </div>

    <div class="htp-section">
      <h3>‚å®Ô∏è Controls</h3>
      <p><strong>Desktop:</strong> ‚Üê ‚Üí Arrow keys to move the bucket. ‚ñ≤ ‚ñº Arrow keys to cycle through bins. Number keys 1‚Äì4 to jump directly to a bin. P or Esc to pause.</p>
      <p><strong>Mobile / D-pad:</strong> Hold ‚óÄ ‚ñ∂ to move the bucket smoothly. Tap ‚ñ≤ ‚ñº to cycle bins up or down. Swipe left/right on the game screen to move directly.</p>
    </div>

    <div class="htp-section">
      <h3>üìä Meters</h3>
      <p><strong>‚ôªÔ∏è Recycle meter</strong> fills with every correct sort ‚Äî shows your positive impact. Fills to 100% = bonus 100 points.</p>
      <p><strong>‚ò£Ô∏è Contamination meter</strong> rises with wrong sorts (+14% each). Reach 100% = Game Over.</p>
      <p><strong>üèôÔ∏è City Health</strong> goes up with correct sorts (+2%) and down with wrong sorts (‚àí5%). Tracks how well your city is doing.</p>
      <p><strong>üóëÔ∏è Landfill</strong> grows when you sort incorrectly (+8%) or miss items falling off screen (+3%). Shrinks slightly with every correct sort. <strong>Reach 100% = Game Over.</strong></p>
    </div>

    <div class="htp-section">
      <h3>‚¨ÜÔ∏è How Levels Work</h3>
      <p>Levels increase based on your <strong>score</strong>, not time. Each correct sort earns points based on waste type √ó your current combo multiplier:</p>
      <div class="bin-grid" style="margin-top:0.75rem;">
        <div class="bin-card org"><h4>üåø Organic</h4><p>10 pts √ó combo</p></div>
        <div class="bin-card rec"><h4>‚ôªÔ∏è Recyclable</h4><p>15 pts √ó combo</p></div>
        <div class="bin-card ewaste"><h4>üíæ E-Waste</h4><p>20 pts √ó combo</p></div>
        <div class="bin-card haz"><h4>‚ò£Ô∏è Hazardous</h4><p>25 pts √ó combo</p></div>
      </div>
      <div class="consequence-box" style="margin-top:0.875rem;">
        <h4>üìà Level thresholds</h4>
        <p>Once your points in the current level reach <strong>level √ó 100</strong>, you advance. Level 1‚Üí2 needs 100 pts. Level 2‚Üí3 needs 200 pts. Level 3‚Üí4 needs 300 pts ‚Äî each level requires 100 more than the last. When you level up, items fall faster and spawn more frequently.</p>
      </div>
      <p style="margin-top:0.75rem;"><strong>üî• Combo tip:</strong> A √ó8 combo on a hazardous item gives 200 pts per catch. Chain correct sorts without a single mistake ‚Äî one wrong sort resets your combo to √ó1.</p>
    </div>

    <div class="htp-section">
      <h3>üèÖ Ranks</h3>
      <div class="bin-grid">
        <div class="bin-card org"><h4>üå± Eco Rookie</h4><p>0 pts</p></div>
        <div class="bin-card rec"><h4>‚öîÔ∏è Waste Warrior</h4><p>500 pts</p></div>
        <div class="bin-card ewaste"><h4>‚ôªÔ∏è Recycling Expert</h4><p>1,500 pts</p></div>
        <div class="bin-card haz"><h4>üèóÔ∏è Sustainability Architect</h4><p>3,000 pts</p></div>
      </div>
      <p style="margin-top:0.75rem; color:var(--bright); font-weight:600;">üëë Waste Master ‚Äî 6,000 pts</p>
    </div>

    <div class="htp-section">
      <h3>üåç What Happens to Your Waste?</h3>
      <div class="consequence-box">
        <h4>üåø Organic waste sorted correctly</h4>
        <p>Food scraps and yard waste sent to composting facilities break down into nutrient-rich soil. When they end up in landfills instead, they decompose without oxygen and produce methane ‚Äî a greenhouse gas 80 times more potent than CO‚ÇÇ over 20 years.</p>
      </div>
      <div class="consequence-box" style="margin-top:0.75rem;">
        <h4>‚ôªÔ∏è Recyclables sorted correctly</h4>
        <p>Paper, glass, metal, and clean plastic sent to recycling centers are processed into new raw materials, reducing the need for resource extraction. Contaminated recyclables ‚Äî even a single greasy pizza box ‚Äî can spoil an entire batch, sending everything to landfill.</p>
      </div>
      <div class="consequence-box" style="margin-top:0.75rem;">
        <h4>‚ò£Ô∏è Hazardous waste handled safely</h4>
        <p>Chemicals, batteries, and medical waste contain toxic compounds that leach into groundwater when disposed of in regular trash. Licensed hazardous waste facilities neutralize these materials, preventing contamination of drinking water supplies.</p>
      </div>
      <div class="consequence-box" style="margin-top:0.75rem;">
        <h4>üíæ E-waste recycled responsibly</h4>
        <p>Electronics contain lead, mercury, and rare earth metals. When shredded at certified e-waste facilities, these materials are recovered and reused, reducing the environmental cost of mining. Discarded improperly, they release toxins that persist in soil for decades.</p>
      </div>
    </div>

    <div style="text-align:center; margin-top:1rem;">
      <button class="btn" id="htpPlay">‚ñ∂ START PLAYING</button>
    </div>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ECOGRID: SKY SORTER ‚Äî Complete Game Engine
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

// ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ
const WASTE_ITEMS = {
  organic:    [{ e:'üçå', n:'Banana Peel', pts:10 }, { e:'üçé', n:'Apple Core', pts:10 }, { e:'üçÉ', n:'Leaves', pts:10 }, { e:'ü•ñ', n:'Food Scraps', pts:10 }],
  recyclable: [{ e:'üß¥', n:'Plastic Bottle', pts:15 }, { e:'üõçÔ∏è', n:'Plastic Bag', pts:15 }, { e:'üì∞', n:'Newspaper', pts:15 }, { e:'üì¶', n:'Cardboard', pts:15 }, { e:'ü•´', n:'Metal Can', pts:15 }, { e:'üçæ', n:'Glass Bottle', pts:15 }],
  hazardous:  [{ e:'üíâ', n:'Syringe', pts:25 }, { e:'‚öóÔ∏è', n:'Chemicals', pts:25 }, { e:'ü™£', n:'Paint Can', pts:25 }],
  ewaste:     [{ e:'üîã', n:'Battery', pts:20 }, { e:'üì±', n:'Old Phone', pts:20 }, { e:'üí°', n:'Light Bulb', pts:20 }, { e:'üñ•Ô∏è', n:'Circuit Board', pts:20 }]
};

const RANKS = [
  { name: 'Eco Rookie', min: 0 }, { name: 'Waste Warrior', min: 500 },
  { name: 'Recycling Expert', min: 1500 }, { name: 'Sustainability Architect', min: 3000 },
  { name: 'Waste Master', min: 6000 }
];

const ECO_FACTS = [
  'Each year, humans produce over 2 billion tonnes of solid waste globally.',
  'Recycling one aluminium can saves enough energy to power a TV for 3 hours.',
  'Glass can be recycled indefinitely without losing quality or purity.',
  'Only 9% of all plastic ever produced has been recycled.',
  'Food waste in landfills generates methane, a greenhouse gas 80√ó more potent than CO‚ÇÇ.',
  'E-waste is the fastest-growing waste stream in the world.',
  'Paper recycling uses 60% less energy than making paper from raw wood.',
  'A single AA battery can contaminate 400 litres of water if landfilled.',
  'Composting diverts organic waste from producing landfill methane.',
  'Mobile phones contain over 60 different elements, many of which can be recovered.'
];

const QUIZ_DATA = [
  { q: 'Which waste type releases methane when buried in landfills?', opts: ['Organic waste', 'Plastic bottles', 'Glass jars', 'Metal cans'], ans: 0 },
  { q: 'What makes glass a particularly valuable recyclable?', opts: ['It is lightweight', 'It can be recycled infinitely', 'It dissolves in water', 'It repels bacteria'], ans: 1 },
  { q: 'Why should batteries never go in regular trash?', opts: ['They are too heavy', 'They contain toxic metals that leach into soil', 'They explode in sunlight', 'They attract rats'], ans: 1 },
  { q: 'What percentage of all plastic ever made has been recycled?', opts: ['About 50%', 'About 30%', 'About 9%', 'About 70%'], ans: 2 },
  { q: 'Recycling one aluminium can saves enough energy to power a TV for how long?', opts: ['30 minutes', '1 hour', '3 hours', '8 hours'], ans: 2 },
  { q: 'What is the fastest-growing waste stream in the world?', opts: ['Plastic packaging', 'Electronic waste', 'Food waste', 'Medical waste'], ans: 1 }
];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let gameState = null; // null = not running
let animFrame = null;
let gameMode = 'classic';
let selectedMode = 'classic';

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// ‚îÄ‚îÄ‚îÄ CANVAS RESIZE ‚îÄ‚îÄ‚îÄ
function resizeCanvas() {
  const wrapper = document.querySelector('.wrapper');
  const w = Math.min(wrapper.clientWidth - 2, 800);
  canvas.style.width = w + 'px';
  const h = Math.round(w * 0.6);
  canvas.style.height = h + 'px';
}
window.addEventListener('resize', resizeCanvas);

// ‚îÄ‚îÄ‚îÄ LOCALSTORAGE HELPERS ‚îÄ‚îÄ‚îÄ
function lsGet(key, def) {
  try { const v = localStorage.getItem(key); return v === null ? def : JSON.parse(v); }
  catch { return def; }
}
function lsSet(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
}

// ‚îÄ‚îÄ‚îÄ SAVE SESSION DATA ‚îÄ‚îÄ‚îÄ
function saveSessionData(gs) {
  const correct = gs.correctSorts;
  const wrong   = gs.wrongSorts;
  const breakdown = gs.breakdown;

  lsSet('ecogrid_correct_sorts',   lsGet('ecogrid_correct_sorts', 0) + correct);
  lsSet('ecogrid_wrong_sorts',     lsGet('ecogrid_wrong_sorts', 0)   + wrong);
  lsSet('ecogrid_sessions_played', lsGet('ecogrid_sessions_played', 0) + 1);
  lsSet('ecogrid_last_played',     new Date().toISOString());

  const prev = lsGet('ecogrid_waste_breakdown', { organic:0, recyclable:0, hazardous:0, ewaste:0 });
  lsSet('ecogrid_waste_breakdown', {
    organic:    (prev.organic    || 0) + (breakdown.organic    || 0),
    recyclable: (prev.recyclable || 0) + (breakdown.recyclable || 0),
    hazardous:  (prev.hazardous  || 0) + (breakdown.hazardous  || 0),
    ewaste:     (prev.ewaste     || 0) + (breakdown.ewaste     || 0)
  });
}

// ‚îÄ‚îÄ‚îÄ HIGH SCORES ‚îÄ‚îÄ‚îÄ
function getHighScores() { return lsGet('ecogrid_high_scores', []); }
function saveHighScore(score, mode) {
  let scores = getHighScores();
  scores.push({ score, mode, rank: getRank(score) });
  scores.sort((a,b) => b.score - a.score);
  scores = scores.slice(0, 10);
  lsSet('ecogrid_high_scores', scores);
}
function getRank(score) {
  let rank = RANKS[0].name;
  for (const r of RANKS) { if (score >= r.min) rank = r.name; }
  return rank;
}

// ‚îÄ‚îÄ‚îÄ GAME OBJECT ‚îÄ‚îÄ‚îÄ
function createGame(mode) {
  return {
    mode, score: 0, combo: 1, level: 1, contamination: 0, recycleBar: 0, cityHealth: 50, landfill: 0,
    items: [], particles: [], bucket: { x: 0.5, vx: 0, type: 'organic', w: 80 },
    correctSorts: 0, wrongSorts: 0,
    breakdown: { organic:0, recyclable:0, hazardous:0, ewaste:0 },
    paused: false, over: false,
    // Time-based spawning (seconds)
    spawnAccum: 0, spawnInterval: 1.8,
    // Time-based eco fact (90‚Äì150 seconds)
    factAccum: 0, factInterval: 90 + Math.random() * 60,
    quizTriggered: false,
    eventAccum: 0, currentEvent: null, eventDuration: 0,
    timerLeft: mode === 'timed' ? 180 : null,
    frameCount: 0,
    elapsedSeconds: 0,   // total seconds played ‚Äî drives smooth speed ramp
    levelProgress: 0,
    powerUp: null, powerUpAccum: 0, powerUpDuration: 0,
    speedBoost: 0,  // extra speed multiplier that fades after level-up
    keys: { left: false, right: false }
  };
}

// ‚îÄ‚îÄ‚îÄ SPAWN ITEM ‚îÄ‚îÄ‚îÄ
function spawnItem(gs) {
  let types = Object.keys(WASTE_ITEMS);
  if (gs.mode === 'challenge') types = ['recyclable'];
  if (gs.currentEvent === 'toxic') types = ['hazardous'];
  if (gs.currentEvent === 'plastic') types = ['recyclable'];
  if (gs.currentEvent === 'ewaste') types = ['ewaste'];

  const type = types[Math.floor(Math.random() * types.length)];
  const items = WASTE_ITEMS[type];
  const item = items[Math.floor(Math.random() * items.length)];
  // Speed ramp: time-based + level bonus so each level-up is clearly felt.
  // Base grows from 0.14 to ~0.38 over 3 min. Each level adds a further 0.018 on top.
  const baseSpeed = 0.14 + gs.elapsedSeconds * 0.0013 + (gs.level - 1) * 0.018;
  const jitter    = (Math.random() - 0.5) * 0.012;
  const vy        = Math.max(0.13, Math.min(0.50, baseSpeed + jitter));

  gs.items.push({
    type, emoji: item.e, name: item.n, pts: item.pts,
    x: 0.1 + Math.random() * 0.8,
    y: -0.05,
    vy,                  // fraction of canvas height per second
    collected: false, missed: false
  });
}

// ‚îÄ‚îÄ‚îÄ COLORS ‚îÄ‚îÄ‚îÄ
const TYPE_COLORS = {
  organic: '#4caf50', recyclable: '#2196f3', hazardous: '#f44336', ewaste: '#9e9e9e'
};

// ‚îÄ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ‚îÄ
function draw(gs) {
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  // Background
  ctx.fillStyle = '#071a0e';
  ctx.fillRect(0, 0, W, H);

  // Grid lines (subtle)
  ctx.strokeStyle = 'rgba(76,175,80,0.05)';
  ctx.lineWidth = 1;
  for (let x = 0; x < W; x += 60) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for (let y = 0; y < H; y += 60) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

  // Items
  for (const item of gs.items) {
    if (item.collected || item.missed) continue;
    const px = item.x * W, py = item.y * H;
    // Glow
    const grd = ctx.createRadialGradient(px, py, 0, px, py, 28);
    const col = TYPE_COLORS[item.type];
    grd.addColorStop(0, col + '44');
    grd.addColorStop(1, 'transparent');
    ctx.fillStyle = grd;
    ctx.beginPath(); ctx.arc(px, py, 28, 0, Math.PI * 2); ctx.fill();
    // Emoji
    ctx.font = `${Math.round(W * 0.05)}px serif`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(item.emoji, px, py);
  }

  // Particles
  for (const p of gs.particles) {
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x * W, p.y * H, p.r * W * 0.004, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;

  // Landfill pile (visual at bottom of screen)
  if (gs.landfill > 0) {
    const pileH = (gs.landfill / 100) * H * 0.18;
    const pileY = H - pileH;
    const grad = ctx.createLinearGradient(0, pileY, 0, H);
    grad.addColorStop(0, 'rgba(121,85,72,0.55)');
    grad.addColorStop(1, 'rgba(62,39,35,0.8)');
    ctx.fillStyle = grad;
    // Jagged pile shape
    ctx.beginPath();
    ctx.moveTo(0, H);
    const segs = 14;
    for (let i = 0; i <= segs; i++) {
      const px2 = (i / segs) * W;
      const jitter = (i % 2 === 0 ? 0 : -pileH * 0.35);
      ctx.lineTo(px2, pileY + jitter);
    }
    ctx.lineTo(W, H);
    ctx.closePath();
    ctx.fill();

    // "LANDFILL" label when over 50%
    if (gs.landfill >= 50) {
      ctx.fillStyle = 'rgba(255,143,0,' + Math.min(1, (gs.landfill - 50) / 50 + 0.4) + ')';
      ctx.font = `bold ${Math.round(W*0.018)}px 'Segoe UI', sans-serif`;
      ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
      ctx.fillText('üóëÔ∏è LANDFILL ' + Math.round(gs.landfill) + '%', W * 0.5, H - 4);
    }
  }

  // Bucket
  const bx = gs.bucket.x * W;
  const by = H - H * 0.08;
  const bw = gs.bucket.w * (W / 800);
  const bh = H * 0.07;
  const col = TYPE_COLORS[gs.bucket.type];

  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.beginPath(); ctx.ellipse(bx, by + bh * 0.7, bw * 0.6, bh * 0.2, 0, 0, Math.PI*2); ctx.fill();

  // Bucket body
  ctx.fillStyle = col;
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.roundRect(bx - bw/2, by - bh/2, bw, bh, 8);
  ctx.fill(); ctx.stroke();

  // Label in bucket
  const labels = { organic:'ORG', recyclable:'REC', hazardous:'HAZ', ewaste:'E-W' };
  const keymap  = { organic:'1', recyclable:'2', hazardous:'3', ewaste:'4' };
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.font = `bold ${Math.round(W*0.018)}px 'Segoe UI', sans-serif`;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(`${keymap[gs.bucket.type]} ${labels[gs.bucket.type]}`, bx, by);

  // Power-up indicator
  if (gs.powerUp) {
    ctx.fillStyle = '#ffd700';
    ctx.font = `${Math.round(W*0.025)}px serif`;
    ctx.textAlign = 'left';
    ctx.fillText(gs.powerUp === 'slowmo' ? 'üê¢' : gs.powerUp === 'magnet' ? 'üß≤' : 'üõ°Ô∏è', W * 0.03, H * 0.06);
  }

  // Event banner on canvas
  if (gs.currentEvent) {
    ctx.fillStyle = 'rgba(244,67,54,0.85)';
    ctx.fillRect(0, H * 0.02, W, H * 0.07);
    ctx.fillStyle = '#fff';
    ctx.font = `bold ${Math.round(W*0.025)}px 'Segoe UI', sans-serif`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    const evNames = { toxic:'‚ö†Ô∏è TOXIC STORM ‚Äî Switch to Red!', plastic:'üõçÔ∏è PLASTIC SURGE ‚Äî Switch to Blue!', ewaste:'üíæ E-WASTE DROP ‚Äî Switch to Grey!' };
    ctx.fillText(evNames[gs.currentEvent] || '', W/2, H * 0.055);
  }
}

// ‚îÄ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ
function spawnParticles(gs, x, y, color) {
  for (let i = 0; i < 8; i++) {
    gs.particles.push({
      x, y, color,
      vx: (Math.random() - 0.5) * 0.015,
      vy: (Math.random() - 0.5) * 0.015,
      r: Math.random() * 2 + 1,
      life: 1
    });
  }
}

// ‚îÄ‚îÄ‚îÄ UPDATE (delta-time based) ‚îÄ‚îÄ‚îÄ
function update(gs, dt) {
  // dt = seconds since last frame, capped to avoid spiral-of-death on tab switch
  dt = Math.min(dt, 0.05);
  if (gs.paused || gs.over) return;
  gs.frameCount++;
  gs.elapsedSeconds += dt;

  // ‚îÄ‚îÄ Bucket movement: direct lerp ‚Äî instant on, instant off, no sluggish build-up ‚îÄ‚îÄ
  const TARGET_SPEED = 0.9; // canvas-widths per second
  const LERP_ON      = 1 - Math.pow(0.01, dt * 18); // reaches full speed in ~2 frames
  const LERP_OFF     = 1 - Math.pow(0.01, dt * 28); // stops in ~1 frame
  let targetVx = 0;
  if (gs.keys.left && !gs.keys.right)  targetVx = -TARGET_SPEED;
  if (gs.keys.right && !gs.keys.left)  targetVx =  TARGET_SPEED;
  const lerpFactor = (targetVx !== 0) ? LERP_ON : LERP_OFF;
  gs.bucket.vx += (targetVx - gs.bucket.vx) * lerpFactor;
  gs.bucket.x  += gs.bucket.vx * dt;
  gs.bucket.x   = Math.max(0.06, Math.min(0.94, gs.bucket.x));
  if (gs.bucket.x <= 0.06 || gs.bucket.x >= 0.94) gs.bucket.vx = 0;

  // ‚îÄ‚îÄ Timer (timed mode) ‚îÄ‚îÄ
  if (gs.timerLeft !== null) {
    gs.timerLeft -= dt;
    if (gs.timerLeft <= 0) { gs.timerLeft = 0; endGame(gs); return; }
    const secs = Math.ceil(gs.timerLeft);
    document.getElementById('hudTimer').textContent =
      Math.floor(secs / 60) + ':' + String(secs % 60).padStart(2, '0');
  }

  // ‚îÄ‚îÄ Spawn (time-based) ‚îÄ‚îÄ
  gs.spawnAccum += dt;
  if (gs.spawnAccum >= gs.spawnInterval) {
    gs.spawnAccum = 0;
    spawnItem(gs);
    // Double-spawn only after 90 seconds
    if (gs.elapsedSeconds > 90) spawnItem(gs);
    // Spawn interval shrinks slowly with time: 3.2s ‚Üí ~1.2s over 3 minutes, never below 1.1s
    gs.spawnInterval = Math.max(0.8, 1.8 - gs.elapsedSeconds * 0.008) + (Math.random() - 0.5) * 0.2;
  }

  // ‚îÄ‚îÄ Eco fact (time-based) ‚îÄ‚îÄ
  gs.factAccum += dt;
  if (gs.factAccum >= gs.factInterval) {
    gs.factAccum    = 0;
    gs.factInterval = 90 + Math.random() * 60;
    showEcoFact(gs);
    return;
  }

  // ‚îÄ‚îÄ Quiz (campaign mode) ‚îÄ‚îÄ
  if (gs.mode === 'campaign' && gs.level > 1 && gs.level % 3 === 0 && !gs.quizTriggered) {
    gs.quizTriggered = true;
    showQuiz(gs);
    return;
  }

  // ‚îÄ‚îÄ Special events (time-based) ‚îÄ‚îÄ
  if (gs.currentEvent) {
    gs.eventDuration -= dt;
    if (gs.eventDuration <= 0) {
      gs.currentEvent = null;
      document.getElementById('eventBanner').textContent = '';
    }
  } else if (gs.elapsedSeconds > 20 && Math.random() < 0.004 * dt * 60) {
    const events = ['toxic', 'plastic', 'ewaste'];
    gs.currentEvent  = events[Math.floor(Math.random() * events.length)];
    gs.eventDuration = 8; // seconds
    const evNames = { toxic:'‚ö†Ô∏è TOXIC STORM', plastic:'üõçÔ∏è PLASTIC SURGE', ewaste:'üíæ E-WASTE DROP' };
    document.getElementById('eventBanner').textContent = evNames[gs.currentEvent];
  }

  // ‚îÄ‚îÄ Power-ups (time-based) ‚îÄ‚îÄ
  if (gs.powerUp) {
    gs.powerUpAccum += dt;
    if (gs.powerUpAccum >= gs.powerUpDuration) { gs.powerUp = null; gs.powerUpAccum = 0; }
  } else if (gs.combo >= 4 && Math.random() < 0.003 * dt * 60) {
    const pups = ['slowmo', 'magnet', 'shield'];
    gs.powerUp         = pups[Math.floor(Math.random() * pups.length)];
    gs.powerUpAccum    = 0;
    gs.powerUpDuration = gs.powerUp === 'shield' ? 8 : 6;
  }

  // Decay speed boost smoothly after level-up
  if (gs.speedBoost > 0) gs.speedBoost = Math.max(0, gs.speedBoost - dt * 0.25);

  const speedMult = (gs.powerUp === 'slowmo') ? 0.45 : (1 + gs.speedBoost);

  // ‚îÄ‚îÄ Move items ‚îÄ‚îÄ
  for (const item of gs.items) {
    if (item.collected || item.missed) continue;
    item.y += item.vy * speedMult * dt;

    // Magnet easing
    if (gs.powerUp === 'magnet' && item.type === gs.bucket.type) {
      const dx = gs.bucket.x - item.x;
      item.x += dx * Math.min(1, 3 * dt);
    }

    // Missed ‚Äî fell off screen
    if (item.y > 1.05) {
      item.missed = true;
      gs.landfill   = Math.min(100, gs.landfill   + 3);
      gs.cityHealth = Math.max(0,   gs.cityHealth - 2);
      if (gs.landfill >= 100) { endGame(gs); return; }
      updateHUD(gs);
    }

    // Catch (bucket collision)
    const bLeft = gs.bucket.x - (gs.bucket.w / 2) / 800;
    const bRight = gs.bucket.x + (gs.bucket.w / 2) / 800;
    const bY     = 1 - 0.12;
    if (!item.collected && item.y >= bY && item.y <= bY + 0.1 &&
        item.x >= bLeft && item.x <= bRight) {
      item.collected = true;

      if (item.type === gs.bucket.type) {
        // ‚úÖ Correct sort
        const pts = Math.round(item.pts * gs.combo);
        gs.score      += pts;
        gs.correctSorts++;
        gs.breakdown[item.type] = (gs.breakdown[item.type] || 0) + 1;
        gs.combo      = Math.min(gs.combo + 1, 16);
        gs.recycleBar = Math.min(100, gs.recycleBar + 8);
        if (gs.recycleBar >= 100) { gs.recycleBar = 0; gs.score += 100; }
        spawnParticles(gs, item.x, item.y, TYPE_COLORS[item.type]);
        gs.cityHealth = Math.min(100, gs.cityHealth + 2);
        gs.landfill   = Math.max(0,   gs.landfill   - 1);
        // Level up
        gs.levelProgress += pts;
        if (gs.levelProgress >= gs.level * 100) {
          gs.levelProgress = 0; gs.level++;
          gs.quizTriggered = false;
          gs.speedBoost = 0.35; // +35% speed surge on level-up, fades over time
          document.getElementById('hudLevel').textContent = gs.level;
          // Level-up flash
          const flash = document.getElementById('levelupFlash');
          if (flash) {
            flash.classList.remove('show');
            void flash.offsetWidth; // reflow to restart animation
            flash.classList.add('show');
            setTimeout(() => flash.classList.remove('show'), 750);
          }
        }
      } else {
        // ‚ùå Wrong sort
        if (gs.powerUp === 'shield') {
          gs.powerUp = null;
          gs.powerUpAccum = 0;
        } else {
          gs.contamination = Math.min(100, gs.contamination + 14);
          gs.combo         = 1;
          gs.wrongSorts++;
          gs.landfill   = Math.min(100, gs.landfill   + 8);
          gs.cityHealth = Math.max(0,   gs.cityHealth - 5);
          spawnParticles(gs, item.x, item.y, '#f44336');
          if (gs.contamination >= 100) { endGame(gs); return; }
          if (gs.landfill >= 100)      { endGame(gs); return; }
        }
      }
      updateHUD(gs);
    }
  }

  // ‚îÄ‚îÄ Particles (time-based fade) ‚îÄ‚îÄ
  gs.particles = gs.particles.filter(p => p.life > 0);
  for (const p of gs.particles) {
    p.x    += p.vx * dt * 60;
    p.y    += p.vy * dt * 60;
    p.life -= 2.5 * dt;
  }

  // Clean up collected/missed items
  if (gs.items.length > 50) gs.items = gs.items.filter(i => !i.collected && !i.missed);
}

// ‚îÄ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ
function updateHUD(gs) {
  document.getElementById('hudScore').textContent = gs.score;
  document.getElementById('hudCombo').textContent  = '√ó' + gs.combo;

  const rec  = Math.round(gs.recycleBar);
  const con  = Math.round(gs.contamination);
  const city = Math.round(gs.cityHealth);
  const land = Math.round(gs.landfill);

  // Recycle bar + %
  document.getElementById('recycleMeter').style.width = rec + '%';
  document.getElementById('recycleMeter').setAttribute('aria-valuenow', rec);
  document.getElementById('recyclePct').textContent = rec + '%';

  // Contamination bar + % (colour shifts red as it rises)
  document.getElementById('contamMeter').style.width = con + '%';
  document.getElementById('contamMeter').setAttribute('aria-valuenow', con);
  const contamEl = document.getElementById('contamPct');
  contamEl.textContent = con + '%';
  contamEl.style.color = con >= 75 ? '#f44336' : con >= 50 ? '#ff8f00' : '#ef9a9a';

  // City health bar + % (green = good, orange = struggling, red = critical)
  document.getElementById('cityHealthMeter').style.width = city + '%';
  document.getElementById('cityHealthMeter').setAttribute('aria-valuenow', city);
  const cityEl = document.getElementById('cityPct');
  cityEl.textContent = city + '%';
  cityEl.style.color = city >= 60 ? 'var(--bright)' : city >= 35 ? '#ffcc80' : '#ef9a9a';

  // Landfill bar + % (colour + pulse when danger)
  const lf = document.getElementById('landfillMeter');
  lf.style.width = land + '%';
  lf.setAttribute('aria-valuenow', land);
  lf.classList.toggle('danger', land >= 75);
  const lfPct = document.getElementById('landfillPct');
  lfPct.textContent = land + '%';
  lfPct.style.color = land >= 75 ? '#f44336' : land >= 50 ? '#ff8f00' : '#ffcc80';
}

// ‚îÄ‚îÄ‚îÄ LOOP (delta-time) ‚îÄ‚îÄ‚îÄ
let lastTimestamp = 0;
function loop(timestamp) {
  if (!gameState) return;
  const dt = lastTimestamp ? Math.min((timestamp - lastTimestamp) / 1000, 0.05) : 0.016;
  lastTimestamp = timestamp;
  update(gameState, dt);
  draw(gameState);
  animFrame = requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ‚îÄ START GAME ‚îÄ‚îÄ‚îÄ
function startGame(mode) {
  gameMode = mode;
  gameState = createGame(mode);
  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('highScoresPanel').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
  document.getElementById('timerHud').style.display = mode === 'timed' ? 'flex' : 'none';
  resizeCanvas();
  updateHUD(gameState);
  updateBucketBtns('organic');
  cancelAnimationFrame(animFrame);
  lastTimestamp = 0;
  animFrame = requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ‚îÄ END GAME ‚îÄ‚îÄ‚îÄ
function endGame(gs) {
  gs.over = true;
  cancelAnimationFrame(animFrame);
  saveSessionData(gs);
  saveHighScore(gs.score, gs.mode);

  // Determine cause of death for flavour
  const byLandfill = gs.landfill >= 100;

  // Show Did You Know ‚Üí City Impact ‚Üí Game Over
  showEndDidYouKnow(byLandfill, () => {
    showCityImpact(gs, () => showGameOver(gs));
  });
}

// ‚îÄ‚îÄ‚îÄ END-GAME DID YOU KNOW ‚îÄ‚îÄ‚îÄ
const LANDFILL_FACTS = [
  'Landfills are the third-largest source of human-related methane emissions in the United States.',
  'A glass bottle takes up to one million years to decompose in a landfill.',
  'The average person generates over 4 lbs of trash per day ‚Äî most of which could be composted or recycled.',
  'When organic waste decomposes in landfills without oxygen, it produces methane ‚Äî 80√ó more potent than CO‚ÇÇ over 20 years.',
  'The world\'s largest landfill, Estrutural in Brazil, covers over 150 hectares and served 2 million people.',
  'Leachate from landfills ‚Äî liquid that seeps through waste ‚Äî can contaminate groundwater for decades.',
  'About 55% of all waste generated globally ends up in landfill, open dumps, or the environment.',
  'If food waste were a country, it would be the third-largest emitter of greenhouse gases on Earth.'
];

function showEndDidYouKnow(byLandfill, callback) {
  const fact = LANDFILL_FACTS[Math.floor(Math.random() * LANDFILL_FACTS.length)];
  document.getElementById('ecoFactText').textContent = fact;

  // Change header text if landfill was the cause
  const screen = document.getElementById('ecoFactScreen');
  const heading = screen.querySelector('h3');
  if (byLandfill) {
    heading.textContent = 'üóëÔ∏è Your landfill is full!';
    screen.querySelector('.fact-icon').textContent = 'üèöÔ∏è';
  } else {
    heading.textContent = 'üí° Did You Know?';
    screen.querySelector('.fact-icon').textContent = 'üåç';
  }

  screen.classList.add('show');

  function dismiss() {
    screen.classList.remove('show');
    screen.removeEventListener('click', dismiss);
    window.removeEventListener('keydown', dismissKey);
    if (callback) callback();
  }
  function dismissKey() { dismiss(); }

  screen.addEventListener('click', dismiss);
  window.addEventListener('keydown', dismissKey, { once: true });
}

// ‚îÄ‚îÄ‚îÄ CITY IMPACT ‚îÄ‚îÄ‚îÄ
function showCityImpact(gs, callback) {
  const total = gs.correctSorts + gs.wrongSorts;
  const ratio = total > 0 ? gs.correctSorts / total : 0;

  let icon, msg;
  if (ratio >= 0.85) {
    icon = 'üèôÔ∏è';
    msg = "Your city's recycling center is thriving. Landfill growth slowed.";
  } else if (ratio >= 0.70) {
    icon = 'üåÜ';
    msg = "Your city is holding steady. A few more correct sorts would help.";
  } else if (ratio >= 0.50) {
    icon = 'üå´Ô∏è';
    msg = "Contamination is spreading. The landfill grew this session.";
  } else {
    icon = 'üèöÔ∏è';
    msg = "Your city is under stress. The landfill expanded significantly.";
  }

  document.getElementById('cityIcon').textContent = icon;
  document.getElementById('cityMsg').textContent = msg;

  const screen = document.getElementById('cityImpactScreen');
  screen.classList.add('show');

  function dismiss() {
    screen.classList.remove('show');
    screen.removeEventListener('click', dismiss);
    window.removeEventListener('keydown', dismissKey);
    if (callback) callback();
  }
  function dismissKey() { dismiss(); }

  screen.addEventListener('click', dismiss);
  window.addEventListener('keydown', dismissKey, { once: true });
}

// ‚îÄ‚îÄ‚îÄ GAME OVER SCREEN ‚îÄ‚îÄ‚îÄ
function showGameOver(gs) {
  document.getElementById('finalScore').textContent = gs.score;
  document.getElementById('finalRank').textContent  = getRank(gs.score);

  // Cause of game over
  const causeEl = document.getElementById('gameOverCause');
  if (gs.landfill >= 100) {
    causeEl.textContent = 'üóëÔ∏è Your city\'s landfill reached 100% capacity.';
    causeEl.style.color = '#ff8f00';
  } else if (gs.contamination >= 100) {
    causeEl.textContent = '‚ò£Ô∏è Contamination overwhelmed the sorting system.';
    causeEl.style.color = '#ef9a9a';
  } else {
    causeEl.textContent = '‚è±Ô∏è Time ran out.';
    causeEl.style.color = 'var(--muted)';
  }

  // Stat values
  const rec  = Math.round(gs.recycleBar);
  const con  = Math.round(gs.contamination);
  const city = Math.round(gs.cityHealth);
  const land = Math.round(gs.landfill);

  // Set text %
  document.getElementById('finalRecyclePct').textContent = rec  + '%';
  document.getElementById('finalcontamPct').textContent  = con  + '%';
  document.getElementById('finalCityHealth').textContent = city + '%';
  document.getElementById('finalLandfill').textContent   = land + '%';

  // Colour the %s
  document.getElementById('finalRecyclePct').style.color = 'var(--accent)';
  document.getElementById('finalcontamPct').style.color  = con  >= 75 ? '#f44336' : '#ef9a9a';
  document.getElementById('finalCityHealth').style.color = city >= 50 ? 'var(--bright)' : city >= 25 ? '#ffcc80' : '#f44336';
  document.getElementById('finalLandfill').style.color   = land >= 75 ? '#f44336' : '#ff8f00';

  // Animate bars: reset to 0 first, then set after a tick so CSS transition plays
  ['finalRecycleBar','finalContamBar','finalCityBar','finalLandfillBar'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.width = '0%';
  });

  document.getElementById('gameOverOverlay').classList.add('show');

  // Delay so bars animate in after overlay appears
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      document.getElementById('finalRecycleBar').style.width  = rec  + '%';
      document.getElementById('finalContamBar').style.width   = con  + '%';
      document.getElementById('finalCityBar').style.width     = city + '%';
      document.getElementById('finalLandfillBar').style.width = land + '%';
    });
  });
}

// ‚îÄ‚îÄ‚îÄ ECO FACT ‚îÄ‚îÄ‚îÄ
function showEcoFact(gs) {
  gs.paused = true;
  const fact = ECO_FACTS[Math.floor(Math.random() * ECO_FACTS.length)];
  document.getElementById('ecoFactText').textContent = fact;
  const screen = document.getElementById('ecoFactScreen');
  screen.classList.add('show');

  function dismiss() {
    screen.classList.remove('show');
    screen.removeEventListener('click', dismiss);
    window.removeEventListener('keydown', dismissKey);
    gs.paused = false;
    lastTimestamp = 0;
    animFrame = requestAnimationFrame(loop);
  }
  function dismissKey() { dismiss(); }
  screen.addEventListener('click', dismiss);
  window.addEventListener('keydown', dismissKey, { once: true });
}

// ‚îÄ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ‚îÄ
function showQuiz(gs) {
  gs.paused = true;
  const q = QUIZ_DATA[Math.floor(Math.random() * QUIZ_DATA.length)];
  document.getElementById('quizQuestion').textContent = q.q;
  document.getElementById('quizFeedback').textContent = '';
  const optsEl = document.getElementById('quizOpts');
  optsEl.innerHTML = '';
  let answered = false;

  q.opts.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'quiz-opt'; btn.textContent = opt; btn.role = 'listitem';
    btn.addEventListener('click', () => {
      if (answered) return;
      answered = true;
      if (i === q.ans) {
        btn.classList.add('correct');
        gs.score += 200;
        document.getElementById('quizFeedback').textContent = '‚úÖ Correct! +200 points';
      } else {
        btn.classList.add('wrong');
        optsEl.children[q.ans].classList.add('correct');
        document.getElementById('quizFeedback').textContent = '‚ùå Not quite ‚Äî that\'s the right answer.';
      }
      updateHUD(gs);
      setTimeout(closeQuiz, 2000);
    });
    optsEl.appendChild(btn);
  });

  document.getElementById('quizOverlay').classList.add('show');

  const autoTimer = setTimeout(closeQuiz, 3000);

  function closeQuiz() {
    clearTimeout(autoTimer);
    document.getElementById('quizOverlay').classList.remove('show');
    gs.paused = false;
    lastTimestamp = 0;
    animFrame = requestAnimationFrame(loop);
  }
}

// ‚îÄ‚îÄ‚îÄ BIN ORDER & COLORS ‚îÄ‚îÄ‚îÄ
const BIN_ORDER  = ['organic', 'recyclable', 'ewaste', 'hazardous'];
const BIN_LABELS = { organic:'1 üåø Organic', recyclable:'2 ‚ôªÔ∏è Recycle', ewaste:'3 üíæ E-Waste', hazardous:'4 ‚ò£Ô∏è Hazardous' };
const BIN_COLORS = { organic:'#4caf50', recyclable:'#2196f3', ewaste:'#9e9e9e', hazardous:'#f44336' };

function updateBucketBtns(type) {
  const badge = document.getElementById('binBadge');
  if (badge) {
    badge.textContent = BIN_LABELS[type];
    badge.style.background = BIN_COLORS[type];
  }
}

function cycleBin(dir) {
  if (!gameState || gameState.over || gameState.paused) return;
  const idx = BIN_ORDER.indexOf(gameState.bucket.type);
  const next = BIN_ORDER[(idx + dir + BIN_ORDER.length) % BIN_ORDER.length];
  gameState.bucket.type = next;
  updateBucketBtns(next);
  // Flash the up/down button briefly
  const btn = document.getElementById(dir === -1 ? 'upBtn' : 'downBtn');
  if (btn) { btn.classList.add('pressed'); setTimeout(() => btn.classList.remove('pressed'), 120); }
}

// ‚îÄ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft')  { e.preventDefault(); if (gameState && !gameState.over) gameState.keys.left  = true; }
  if (e.key === 'ArrowRight') { e.preventDefault(); if (gameState && !gameState.over) gameState.keys.right = true; }
  if (e.key === 'ArrowUp')    { e.preventDefault(); cycleBin(-1); }
  if (e.key === 'ArrowDown')  { e.preventDefault(); cycleBin(1);  }
  if (!gameState || gameState.over) return;
  if (e.key === '1') { gameState.bucket.type = 'organic';    updateBucketBtns('organic'); }
  if (e.key === '2') { gameState.bucket.type = 'recyclable'; updateBucketBtns('recyclable'); }
  if (e.key === '3') { gameState.bucket.type = 'ewaste';     updateBucketBtns('ewaste'); }
  if (e.key === '4') { gameState.bucket.type = 'hazardous';  updateBucketBtns('hazardous'); }
  if (e.key === 'p' || e.key === 'P' || e.key === 'Escape') togglePause();
});
document.addEventListener('keyup', e => {
  if (e.key === 'ArrowLeft')  { if (gameState) gameState.keys.left  = false; }
  if (e.key === 'ArrowRight') { if (gameState) gameState.keys.right = false; }
});

// ‚îÄ‚îÄ‚îÄ D-PAD BUTTONS ‚îÄ‚îÄ‚îÄ
function bindHold(id, onFn) {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('mousedown',  () => onFn(true));
  el.addEventListener('mouseup',    () => onFn(false));
  el.addEventListener('mouseleave', () => onFn(false));
  el.addEventListener('touchstart', e => { e.preventDefault(); onFn(true);  }, { passive: false });
  el.addEventListener('touchend',   e => { e.preventDefault(); onFn(false); }, { passive: false });
  el.addEventListener('touchcancel',() => onFn(false));
}

bindHold('leftBtn',  on => { if (gameState && !gameState.over) gameState.keys.left  = on; });
bindHold('rightBtn', on => { if (gameState && !gameState.over) gameState.keys.right = on; });

// Up / Down: single-fire on press (not hold), with debounce so holding doesn't spam
let binCycleTimer = null;
function bindCycle(id, dir) {
  const el = document.getElementById(id);
  if (!el) return;
  function fire() {
    cycleBin(dir);
    binCycleTimer = setTimeout(() => { binCycleTimer = null; }, 200);
  }
  el.addEventListener('mousedown',  () => { if (!binCycleTimer) fire(); });
  el.addEventListener('touchstart', e => { e.preventDefault(); if (!binCycleTimer) fire(); }, { passive: false });
}
bindCycle('upBtn',   -1);
bindCycle('downBtn',  1);

document.getElementById('pauseBtn').addEventListener('click', togglePause);

// ‚îÄ‚îÄ‚îÄ TOUCH / SWIPE on canvas ‚îÄ‚îÄ‚îÄ
let touchStartX = null;
canvas.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
canvas.addEventListener('touchmove', e => {
  if (!gameState || !touchStartX) return;
  const dx = e.touches[0].clientX - touchStartX;
  // Live drag ‚Äî move bucket in real time
  gameState.bucket.x = Math.max(0.06, Math.min(0.94, gameState.bucket.x + dx / canvas.clientWidth * 1.4));
  touchStartX = e.touches[0].clientX;
}, { passive: true });
canvas.addEventListener('touchend', () => { touchStartX = null; }, { passive: true });

// ‚îÄ‚îÄ‚îÄ PAUSE ‚îÄ‚îÄ‚îÄ
function clearKeys() { if (gameState) { gameState.keys.left = false; gameState.keys.right = false; } }

function togglePause() {
  if (!gameState || gameState.over) return;
  gameState.paused = !gameState.paused;
  clearKeys();
  if (gameState.paused) {
    cancelAnimationFrame(animFrame);
    document.getElementById('pauseOverlay').classList.add('show');
  } else {
    document.getElementById('pauseOverlay').classList.remove('show');
    lastTimestamp = 0;
    animFrame = requestAnimationFrame(loop);
  }
}

document.getElementById('resumeBtn').addEventListener('click', () => {
  document.getElementById('pauseOverlay').classList.remove('show');
  clearKeys();
  lastTimestamp = 0;
  if (gameState) { gameState.paused = false; animFrame = requestAnimationFrame(loop); }
});

document.getElementById('menuBtn').addEventListener('click', goToMenu);
document.getElementById('mainMenuBtn').addEventListener('click', () => {
  document.getElementById('gameOverOverlay').classList.remove('show');
  goToMenu();
});
document.getElementById('playAgainBtn').addEventListener('click', () => {
  document.getElementById('gameOverOverlay').classList.remove('show');
  startGame(gameMode);
});

function goToMenu() {
  cancelAnimationFrame(animFrame);
  gameState = null;
  document.getElementById('gameArea').style.display = 'none';
  document.getElementById('pauseOverlay').classList.remove('show');
  document.getElementById('gameOverOverlay').classList.remove('show');
  document.getElementById('modeSelect').style.display = 'block';
}

// ‚îÄ‚îÄ‚îÄ MODE CARDS ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.mode-card').forEach(card => {
  function select() {
    document.querySelectorAll('.mode-card').forEach(c => c.style.borderColor = '');
    card.style.borderColor = 'var(--bright)';
    selectedMode = card.dataset.mode;
  }
  card.addEventListener('click', select);
  card.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); select(); } });
});

document.getElementById('playBtn').addEventListener('click', () => startGame(selectedMode));

// ‚îÄ‚îÄ‚îÄ HOW TO PLAY ‚îÄ‚îÄ‚îÄ
document.getElementById('howToPlayBtn').addEventListener('click', () => {
  document.getElementById('howToPlay').classList.add('show');
  document.getElementById('htpClose').focus();
});
document.getElementById('htpClose').addEventListener('click', () => document.getElementById('howToPlay').classList.remove('show'));
document.getElementById('htpPlay').addEventListener('click', () => {
  document.getElementById('howToPlay').classList.remove('show');
  startGame(selectedMode);
});

// ‚îÄ‚îÄ‚îÄ HIGH SCORES ‚îÄ‚îÄ‚îÄ
document.getElementById('highScoresBtn').addEventListener('click', () => {
  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('highScoresPanel').style.display = 'block';
  renderHighScores();
});
document.getElementById('backFromScores').addEventListener('click', () => {
  document.getElementById('highScoresPanel').style.display = 'none';
  document.getElementById('modeSelect').style.display = 'block';
});

function renderHighScores() {
  const scores = getHighScores();
  const tbody = document.getElementById('scoresTbody');
  const noMsg = document.getElementById('noScoresMsg');
  tbody.innerHTML = '';
  if (!scores.length) { noMsg.style.display = 'block'; return; }
  noMsg.style.display = 'none';
  scores.forEach((s, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${s.score}</td><td>${s.rank}</td><td>${s.mode}</td>`;
    tbody.appendChild(tr);
  });
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
resizeCanvas();
</script>
</body>
</html>